<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä CSV —Ñ–∞–π–ª–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(235, 51, 73, 0.4);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            z-index: 1;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 1;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            min-width: 150px;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            min-width: 150px;
        }

        tbody tr:hover {
            background-color: #f5f5f5;
        }

        input[type="text"],
        input[type="tel"] {
            width: 100%;
            min-width: 200px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus {
            outline: none;
            border-color: #667eea;
        }

        input.error {
            border-color: #eb3349;
        }

        .coord-input {
            width: 140px;
            min-width: 140px;
        }

        .time-input {
            width: 90px;
            min-width: 90px;
        }

        .narrow-input {
            width: 130px;
            min-width: 130px;
        }

        .wide-input {
            width: 100%;
            min-width: 300px;
        }

        .delete-btn {
            background: #eb3349;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #d62839;
            transform: scale(1.05);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .row-number {
            font-weight: 600;
            color: #667eea;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –†–µ–¥–∞–∫—Ç–æ—Ä CSV —Ñ–∞–π–ª–æ–≤</h1>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="addRow()">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
            </button>
            <button class="btn btn-success" onclick="downloadCSV()">
                üíæ –°–∫–∞—á–∞—Ç—å CSV
            </button>
            <div class="btn btn-primary file-input-wrapper">
                <label class="btn btn-primary" for="fileInput">
                    üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV
                </label>
                <input type="file" id="fileInput" accept=".csv" onchange="loadCSV(event)">
            </div>
            <button class="btn btn-danger" onclick="clearAll()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
            </button>
        </div>

        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>‚Ññ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ò–ù–ù</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏</th>
                        <th>–ê–¥—Ä–µ—Å —Ç–æ—á–∫–∏</th>
                        <th>–®–∏—Ä–æ—Ç–∞</th>
                        <th>–î–æ–ª–≥–æ—Ç–∞</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ü–Ω –Ω–∞—á–∞–ª–æ</th>
                        <th>–ü–Ω –∫–æ–Ω–µ—Ü</th>
                        <th>–í—Ç –Ω–∞—á–∞–ª–æ</th>
                        <th>–í—Ç –∫–æ–Ω–µ—Ü</th>
                        <th>–°—Ä –Ω–∞—á–∞–ª–æ</th>
                        <th>–°—Ä –∫–æ–Ω–µ—Ü</th>
                        <th>–ß—Ç –Ω–∞—á–∞–ª–æ</th>
                        <th>–ß—Ç –∫–æ–Ω–µ—Ü</th>
                        <th>–ü—Ç –Ω–∞—á–∞–ª–æ</th>
                        <th>–ü—Ç –∫–æ–Ω–µ—Ü</th>
                        <th>–°–± –Ω–∞—á–∞–ª–æ</th>
                        <th>–°–± –∫–æ–Ω–µ—Ü</th>
                        <th>–í—Å –Ω–∞—á–∞–ª–æ</th>
                        <th>–í—Å –∫–æ–Ω–µ—Ü</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let rowCounter = 1;

        function addRow(data = null) {
            const tbody = document.getElementById('tableBody');
            const row = tbody.insertRow();
            
            const defaultData = data || {
                num: rowCounter++,
                name: '',
                inn: '',
                pointName: '',
                address: '',
                lat: '',
                lon: '',
                phone: '',
                mon_start: '', mon_end: '',
                tue_start: '', tue_end: '',
                wed_start: '', wed_end: '',
                thu_start: '', thu_end: '',
                fri_start: '', fri_end: '',
                sat_start: '', sat_end: '',
                sun_start: '', sun_end: ''
            };

            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –≤ —Å—Ç—Ä–æ–∫–∞—Ö, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–∞—Å—å HTML-—Ä–∞–∑–º–µ—Ç–∫–∞
            const escapeHtml = (str) => String(str).replace(/"/g, '&quot;');

            row.innerHTML = `
                <td class="row-number">${defaultData.num}</td>
                <td><input type="text" class="wide-input" value="${escapeHtml(defaultData.name)}" placeholder="–û–û–û –ö–æ–º–ø–∞–Ω–∏—è"></td>
                <td><input type="text" class="narrow-input" value="${escapeHtml(defaultData.inn)}" placeholder="1234567890" maxlength="12"></td>
                <td><input type="text" class="wide-input" value="${escapeHtml(defaultData.pointName)}" placeholder="–ú–∞–≥–∞–∑–∏–Ω –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π"></td>
                <td><input type="text" class="wide-input" value="${escapeHtml(defaultData.address)}" placeholder="–≥. –ì–æ—Ä–æ–¥, —É–ª. –£–ª–∏—Ü–∞, –¥. 1"></td>
                <td><input type="text" class="coord-input" value="${escapeHtml(defaultData.lat)}" placeholder="55.751244" oninput="validateCoordinate(this)"></td>
                <td><input type="text" class="coord-input" value="${escapeHtml(defaultData.lon)}" placeholder="37.618423" oninput="validateCoordinate(this)"></td>
                <td><input type="tel" value="${defaultData.phone}" placeholder="+79091234567" oninput="formatPhone(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.mon_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.mon_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.tue_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.tue_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.wed_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.wed_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.thu_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.thu_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.fri_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.fri_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.sat_start}" placeholder="10:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.sat_end}" placeholder="20:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.sun_start}" placeholder="10:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.sun_end}" placeholder="20:00" oninput="formatTime(this)"></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">‚ùå</button></td>
            `;
        }

        function deleteRow(btn) {
            const row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
            showNotification('–°—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        }

        function validateCoordinate(input) {
            let value = input.value.replace(',', '.');
            
            // –†–∞–∑—Ä–µ—à–∞–µ–º –≤–≤–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, —Ç–æ—á–∫—É –∏ –º–∏–Ω—É—Å
            value = value.replace(/[^\d.-]/g, '');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
            const parts = value.split('.');
            if (parts.length === 2) {
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 6 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏
                if (parts[1].length > 6) {
                    parts[1] = parts[1].substring(0, 6);
                    value = parts.join('.');
                }
            }
            
            input.value = value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –æ—à–∏–±–æ–∫
            if (value && parts.length === 2 && parts[1].length === 6) {
                input.classList.remove('error');
            } else if (value && parts.length === 2) {
                input.classList.add('error');
            }
        }

        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');
            
            if (value.length > 0) {
                if (value[0] === '7' || value[0] === '8') {
                    value = '7' + value.substring(1);
                }
                
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                if (value.length >= 1) {
                    let formatted = '+7';
                    if (value.length > 1) formatted += value.substring(1, 4);
                    if (value.length > 4) formatted += value.substring(4, 7);
                    if (value.length > 7) formatted += value.substring(7, 9);
                    if (value.length > 9) formatted += value.substring(9, 11);
                    input.value = formatted;
                }
            }
        }

        function formatTime(input) {
            let value = input.value.replace(/\D/g, '');
            
            if (value.length > 4) {
                value = value.substring(0, 4);
            }
            
            if (value.length >= 3) {
                value = value.substring(0, 2) + ':' + value.substring(2, 4);
            }
            
            input.value = value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
            if (value.length === 5) {
                const [hours, minutes] = value.split(':').map(Number);
                if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                    input.classList.remove('error');
                } else {
                    input.classList.add('error');
                }
            }
        }

        function getRowData(row) {
            const inputs = row.querySelectorAll('input');
            const data = [row.cells[0].textContent]; // –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏
            
            for (let i = 0; i < inputs.length; i++) {
                data.push(inputs[i].value);
            }
            
            return data;
        }

        function isRowEmpty(data) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø–æ–ª—è –∫—Ä–æ–º–µ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫–∏
            for (let i = 1; i < 8; i++) { // –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                if (data[i] && data[i].trim() !== '') {
                    return false;
                }
            }
            return true;
        }

        function isRowValid(data) {
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è - –æ–Ω–∞ –≤–∞–ª–∏–¥–Ω–∞ (–ø—Ä–æ—Å—Ç–æ –Ω–µ –≤–∫–ª—é—á–∞–µ–º –≤ CSV)
            if (isRowEmpty(data)) return true;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–≤—Å–µ –∫—Ä–æ–º–µ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã)
            for (let i = 1; i < 8; i++) {
                if (!data[i] || data[i].trim() === '') {
                    return false;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å 6 –∑–Ω–∞–∫–∞–º–∏ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏)
            const lat = data[5];
            const lon = data[6];
            
            if (lat && !lat.match(/^-?\d+\.\d{6}$/)) return false;
            if (lon && !lon.match(/^-?\d+\.\d{6}$/)) return false;
            
            return true;
        }

        function downloadCSV() {
            const table = document.getElementById('dataTable');
            const rows = table.querySelectorAll('tbody tr');
            
            if (rows.length === 0) {
                showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            let csvContent = '';
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            const headers = [
                '‚Ññ', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ò–ù–ù', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏', '–ê–¥—Ä–µ—Å —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏',
                '–®–∏—Ä–æ—Ç–∞', '–î–æ–ª–≥–æ—Ç–∞', '–ö–æ–Ω—Ç–∞–∫—Ç—ã —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏',
                '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
                '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤–æ –≤—Ç–æ—Ä–Ω–∏–∫', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤–æ –≤—Ç–æ—Ä–Ω–∏–∫',
                '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ —Å—Ä–µ–¥—É', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ —Å—Ä–µ–¥—É',
                '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ —á–µ—Ç–≤–µ—Ä–≥', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ —á–µ—Ç–≤–µ—Ä–≥',
                '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ –ø—è—Ç–Ω–∏—Ü—É', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ –ø—è—Ç–Ω–∏—Ü—É',
                '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ —Å—É–±–±–æ—Ç—É', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ —Å—É–±–±–æ—Ç—É',
                '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
            ];
            csvContent += headers.join(';') + '\n';
            
            // –î–∞–Ω–Ω—ã–µ
            let validRowCount = 0;
            let invalidRows = [];
            
            rows.forEach((row, index) => {
                const rowData = getRowData(row);
                
                if (!isRowEmpty(rowData)) {
                    if (!isRowValid(rowData)) {
                        invalidRows.push(index + 1);
                        return;
                    }
                    csvContent += rowData.join(';') + '\n';
                    validRowCount++;
                }
            });
            
            if (invalidRows.length > 0) {
                showNotification(`–û—à–∏–±–∫–∞: —Å—Ç—Ä–æ–∫–∏ ${invalidRows.join(', ')} –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ`, 'error');
                return;
            }
            
            if (validRowCount === 0) {
                showNotification('–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Windows-1251
            const blob = new Blob([convertToWindows1251(csvContent)], { 
                type: 'text/csv;charset=windows-1251' 
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification(`CSV —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω (${validRowCount} —Å—Ç—Ä–æ–∫)`, 'success');
        }

        function convertToWindows1251(text) {
            const win1251 = {
                '–ê': 0xC0, '–ë': 0xC1, '–í': 0xC2, '–ì': 0xC3, '–î': 0xC4, '–ï': 0xC5, '–Å': 0xA8,
                '–ñ': 0xC6, '–ó': 0xC7, '–ò': 0xC8, '–ô': 0xC9, '–ö': 0xCA, '–õ': 0xCB, '–ú': 0xCC,
                '–ù': 0xCD, '–û': 0xCE, '–ü': 0xCF, '–†': 0xD0, '–°': 0xD1, '–¢': 0xD2, '–£': 0xD3,
                '–§': 0xD4, '–•': 0xD5, '–¶': 0xD6, '–ß': 0xD7, '–®': 0xD8, '–©': 0xD9, '–™': 0xDA,
                '–´': 0xDB, '–¨': 0xDC, '–≠': 0xDD, '–Æ': 0xDE, '–Ø': 0xDF,
                '–∞': 0xE0, '–±': 0xE1, '–≤': 0xE2, '–≥': 0xE3, '–¥': 0xE4, '–µ': 0xE5, '—ë': 0xB8,
                '–∂': 0xE6, '–∑': 0xE7, '–∏': 0xE8, '–π': 0xE9, '–∫': 0xEA, '–ª': 0xEB, '–º': 0xEC,
                '–Ω': 0xED, '–æ': 0xEE, '–ø': 0xEF, '—Ä': 0xF0, '—Å': 0xF1, '—Ç': 0xF2, '—É': 0xF3,
                '—Ñ': 0xF4, '—Ö': 0xF5, '—Ü': 0xF6, '—á': 0xF7, '—à': 0xF8, '—â': 0xF9, '—ä': 0xFA,
                '—ã': 0xFB, '—å': 0xFC, '—ç': 0xFD, '—é': 0xFE, '—è': 0xFF,
                '‚Ññ': 0xB9
            };
            
            const bytes = new Uint8Array(text.length);
            
            for (let i = 0; i < text.length; i++) {
                const char = text.charAt(i);
                if (win1251[char]) {
                    bytes[i] = win1251[char];
                } else if (char.charCodeAt(0) < 128) {
                    bytes[i] = char.charCodeAt(0);
                } else {
                    bytes[i] = 0x3F; // '?'
                }
            }
            
            return bytes;
        }

        function loadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const bytes = new Uint8Array(arrayBuffer);
                const text = convertFromWindows1251(bytes);
                parseCSV(text);
            };
            reader.readAsArrayBuffer(file);
        }

        function convertFromWindows1251(bytes) {
            const win1251Reverse = {
                0xC0: '–ê', 0xC1: '–ë', 0xC2: '–í', 0xC3: '–ì', 0xC4: '–î', 0xC5: '–ï', 0xA8: '–Å',
                0xC6: '–ñ', 0xC7: '–ó', 0xC8: '–ò', 0xC9: '–ô', 0xCA: '–ö', 0xCB: '–õ', 0xCC: '–ú',
                0xCD: '–ù', 0xCE: '–û', 0xCF: '–ü', 0xD0: '–†', 0xD1: '–°', 0xD2: '–¢', 0xD3: '–£',
                0xD4: '–§', 0xD5: '–•', 0xD6: '–¶', 0xD7: '–ß', 0xD8: '–®', 0xD9: '–©', 0xDA: '–™',
                0xDB: '–´', 0xDC: '–¨', 0xDD: '–≠', 0xDE: '–Æ', 0xDF: '–Ø',
                0xE0: '–∞', 0xE1: '–±', 0xE2: '–≤', 0xE3: '–≥', 0xE4: '–¥', 0xE5: '–µ', 0xB8: '—ë',
                0xE6: '–∂', 0xE7: '–∑', 0xE8: '–∏', 0xE9: '–π', 0xEA: '–∫', 0xEB: '–ª', 0xEC: '–º',
                0xED: '–Ω', 0xEE: '–æ', 0xEF: '–ø', 0xF0: '—Ä', 0xF1: '—Å', 0xF2: '—Ç', 0xF3: '—É',
                0xF4: '—Ñ', 0xF5: '—Ö', 0xF6: '—Ü', 0xF7: '—á', 0xF8: '—à', 0xF9: '—â', 0xFA: '—ä',
                0xFB: '—ã', 0xFC: '—å', 0xFD: '—ç', 0xFE: '—é', 0xFF: '—è', 0xB9: '‚Ññ'
            };
            
            let text = '';
            for (let i = 0; i < bytes.length; i++) {
                const byte = bytes[i];
                if (win1251Reverse[byte]) {
                    text += win1251Reverse[byte];
                } else if (byte < 128) {
                    text += String.fromCharCode(byte);
                } else {
                    text += '?';
                }
            }
            
            return text;
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            
            // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            document.getElementById('tableBody').innerHTML = '';
            rowCounter = 1;
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';');
                
                if (values.length >= 8) {
                    const data = {
                        num: values[0] || rowCounter,
                        name: values[1] || '',
                        inn: values[2] || '',
                        pointName: values[3] || '',
                        address: values[4] || '',
                        lat: values[5] || '',
                        lon: values[6] || '',
                        phone: values[7] || '',
                        mon_start: values[8] || '',
                        mon_end: values[9] || '',
                        tue_start: values[10] || '',
                        tue_end: values[11] || '',
                        wed_start: values[12] || '',
                        wed_end: values[13] || '',
                        thu_start: values[14] || '',
                        thu_end: values[15] || '',
                        fri_start: values[16] || '',
                        fri_end: values[17] || '',
                        sat_start: values[18] || '',
                        sat_end: values[19] || '',
                        sun_start: values[20] || '',
                        sun_end: values[21] || ''
                    };
                    
                    addRow(data);
                    rowCounter++;
                }
            }
            
            showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${lines.length - 1} —Å—Ç—Ä–æ–∫`, 'success');
        }

        function clearAll() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏?')) {
                document.getElementById('tableBody').innerHTML = '';
                rowCounter = 1;
                showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã', 'success');
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            addRow();
        };
    </script>
</body>
</html>