<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä CSV —Ñ–∞–π–ª–æ–≤</title>
    <link rel="shortcut icon" href="favicon.webp" type="image/webp">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É SheetJS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(235, 51, 73, 0.4);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            z-index: 1;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 1;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            min-width: 150px;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            min-width: 150px;
        }

        tbody tr:hover {
            background-color: #f5f5f5;
        }

        input[type="text"],
        input[type="tel"] {
            width: 100%;
            min-width: 200px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus {
            outline: none;
            border-color: #667eea;
        }

        input.error {
            border-color: #eb3349;
        }

        .coord-input {
            width: 140px;
            min-width: 140px;
        }

        .time-input {
            width: 90px;
            min-width: 90px;
        }

        .narrow-input {
            width: 130px;
            min-width: 130px;
        }

        .wide-input {
            width: 100%;
            min-width: 300px;
        }

        .delete-btn {
            background: #eb3349;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #d62839;
            transform: scale(1.05);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .notification.success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .row-number {
            font-weight: 600;
            color: #667eea;
            text-align: center;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #eb3349;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }

        .error-list {
            list-style: none;
            padding: 0;
        }

        .error-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #fff5f5;
            border-left: 4px solid #eb3349;
            border-radius: 5px;
        }

        .error-item strong {
            color: #eb3349;
        }

        .warning-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #fffbf0;
            border-left: 4px solid #f2994a;
            border-radius: 5px;
        }

        .warning-item strong {
            color: #f2994a;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –†–µ–¥–∞–∫—Ç–æ—Ä CSV —Ñ–∞–π–ª–æ–≤</h1>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="addRow()">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
            </button>
            <button class="btn btn-success" onclick="downloadCSV()">
                üíæ –°–∫–∞—á–∞—Ç—å CSV
            </button>
            <button class="btn btn-primary" onclick="downloadTemplateCSV()">
                üìÑ –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω CSV
            </button>
            <button class="btn btn-success" onclick="downloadExcel()">
                üìä –°–∫–∞—á–∞—Ç—å Excel
            </button>
            <div class="btn btn-primary file-input-wrapper">
                <label class="btn btn-primary" for="fileInput">
                    üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å CSV
                </label>
                <input type="file" id="fileInput" accept=".csv" onchange="loadCSV(event)">
            </div>
            <div class="btn btn-primary file-input-wrapper">
                <label class="btn btn-primary" for="excelFileInput">
                    üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel
                </label>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="loadExcel(event)">
            </div>
            <button class="btn btn-danger" onclick="clearAll()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
            </button>
        </div>

        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>‚Ññ</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ò–ù–ù</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏</th>
                        <th>–ê–¥—Ä–µ—Å —Ç–æ—á–∫–∏</th>
                        <th>–®–∏—Ä–æ—Ç–∞</th>
                        <th>–î–æ–ª–≥–æ—Ç–∞</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ü–Ω –Ω–∞—á–∞–ª–æ</th>
                        <th>–ü–Ω –∫–æ–Ω–µ—Ü</th>
                        <th>–í—Ç –Ω–∞—á–∞–ª–æ</th>
                        <th>–í—Ç –∫–æ–Ω–µ—Ü</th>
                        <th>–°—Ä –Ω–∞—á–∞–ª–æ</th>
                        <th>–°—Ä –∫–æ–Ω–µ—Ü</th>
                        <th>–ß—Ç –Ω–∞—á–∞–ª–æ</th>
                        <th>–ß—Ç –∫–æ–Ω–µ—Ü</th>
                        <th>–ü—Ç –Ω–∞—á–∞–ª–æ</th>
                        <th>–ü—Ç –∫–æ–Ω–µ—Ü</th>
                        <th>–°–± –Ω–∞—á–∞–ª–æ</th>
                        <th>–°–± –∫–æ–Ω–µ—Ü</th>
                        <th>–í—Å –Ω–∞—á–∞–ª–æ</th>
                        <th>–í—Å –∫–æ–Ω–µ—Ü</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫ -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="errorContent"></div>
        </div>
    </div>

    <script>
        let rowCounter = 1;

        const CSV_HEADERS = [
            '‚Ññ', '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', '–ò–ù–ù', '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏', '–ê–¥—Ä–µ—Å —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏',
            '–®–∏—Ä–æ—Ç–∞', '–î–æ–ª–≥–æ—Ç–∞', '–ö–æ–Ω—Ç–∞–∫—Ç—ã —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏',
            '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
            '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤–æ –≤—Ç–æ—Ä–Ω–∏–∫', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤–æ –≤—Ç–æ—Ä–Ω–∏–∫',
            '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ —Å—Ä–µ–¥—É', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ —Å—Ä–µ–¥—É',
            '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ —á–µ—Ç–≤–µ—Ä–≥', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ —á–µ—Ç–≤–µ—Ä–≥',
            '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ –ø—è—Ç–Ω–∏—Ü—É', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ –ø—è—Ç–Ω–∏—Ü—É',
            '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ —Å—É–±–±–æ—Ç—É', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ —Å—É–±–±–æ—Ç—É',
            '–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
        ];

        function addRow(data = null) {
            const tbody = document.getElementById('tableBody');
            const row = tbody.insertRow();

            const defaultData = data || {
                num: rowCounter++,
                name: '',
                inn: '',
                pointName: '',
                address: '',
                lat: '',
                lon: '',
                phone: '',
                mon_start: '', mon_end: '',
                tue_start: '', tue_end: '',
                wed_start: '', wed_end: '',
                thu_start: '', thu_end: '',
                fri_start: '', fri_end: '',
                sat_start: '', sat_end: '',
                sun_start: '', sun_end: ''
            };

            const escapeHtml = (str) => String(str).replace(/"/g, '&quot;');

            row.innerHTML = `
                <td class="row-number">${defaultData.num}</td>
                <td><input type="text" class="wide-input" value="${escapeHtml(defaultData.name)}" placeholder="–û–û–û –ö–æ–º–ø–∞–Ω–∏—è"></td>
                <td><input type="text" class="narrow-input" value="${escapeHtml(defaultData.inn)}" placeholder="1234567890" maxlength="12"></td>
                <td><input type="text" class="wide-input" value="${escapeHtml(defaultData.pointName)}" placeholder="–ú–∞–≥–∞–∑–∏–Ω –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π"></td>
                <td><input type="text" class="wide-input" value="${escapeHtml(defaultData.address)}" placeholder="–≥. –ì–æ—Ä–æ–¥, —É–ª. –£–ª–∏—Ü–∞, –¥. 1"></td>
                <td><input type="text" class="coord-input" value="${escapeHtml(defaultData.lat)}" placeholder="55.751244" oninput="validateCoordinate(this)"></td>
                <td><input type="text" class="coord-input" value="${escapeHtml(defaultData.lon)}" placeholder="37.618423" oninput="validateCoordinate(this)"></td>
                <td><input type="tel" value="${defaultData.phone}" placeholder="+79091234567" oninput="formatPhone(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.mon_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.mon_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.tue_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.tue_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.wed_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.wed_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.thu_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.thu_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.fri_start}" placeholder="09:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.fri_end}" placeholder="21:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.sat_start}" placeholder="10:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.sat_end}" placeholder="20:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.sun_start}" placeholder="10:00" oninput="formatTime(this)"></td>
                <td><input type="text" class="time-input" value="${defaultData.sun_end}" placeholder="20:00" oninput="formatTime(this)"></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">‚ùå</button></td>
            `;
        }

        function deleteRow(btn) {
            const row = btn.parentNode.parentNode;
            row.parentNode.removeChild(row);
            showNotification('–°—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
        }

        function validateCoordinate(input) {
            let value = input.value.replace(',', '.');
            value = value.replace(/[^\d.-]/g, '');

            const parts = value.split('.');
            if (parts.length === 2) {
                if (parts[1].length > 6) {
                    parts[1] = parts[1].substring(0, 6);
                    value = parts.join('.');
                }
            }

            input.value = value;

            if (value && parts.length === 2 && parts[1].length === 6) {
                input.classList.remove('error');
            } else if (value && parts.length === 2) {
                input.classList.add('error');
            }
        }

        function formatPhone(input) {
            let value = input.value.replace(/\D/g, '');

            if (value.length > 0) {
                if (value[0] === '7' || value[0] === '8') {
                    value = '7' + value.substring(1);
                }

                if (value.length > 11) {
                    value = value.substring(0, 11);
                }

                if (value.length >= 1) {
                    let formatted = '+7';
                    if (value.length > 1) formatted += value.substring(1, 4);
                    if (value.length > 4) formatted += value.substring(4, 7);
                    if (value.length > 7) formatted += value.substring(7, 9);
                    if (value.length > 9) formatted += value.substring(9, 11);
                    input.value = formatted;
                }
            }
        }

        function formatTime(input) {
            let value = input.value.replace(/\D/g, '');

            if (value.length > 4) {
                value = value.substring(0, 4);
            }

            if (value.length >= 3) {
                value = value.substring(0, 2) + ':' + value.substring(2, 4);
            }

            input.value = value;

            if (value.length === 5) {
                const [hours, minutes] = value.split(':').map(Number);
                if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                    input.classList.remove('error');
                } else {
                    input.classList.add('error');
                }
            }
        }

        function getRowData(row) {
            const inputs = row.querySelectorAll('input');
            const data = [row.cells[0].textContent];

            for (let i = 0; i < inputs.length; i++) {
                data.push(inputs[i].value);
            }

            return data;
        }

        function isRowEmpty(data) {
            for (let i = 1; i < 8; i++) {
                if (data[i] && data[i].trim() !== '') {
                    return false;
                }
            }
            return true;
        }

        function isRowValid(data) {
            if (isRowEmpty(data)) return true;

            for (let i = 1; i < 8; i++) {
                if (!data[i] || data[i].trim() === '') {
                    return false;
                }
            }

            const lat = data[5];
            const lon = data[6];

            if (lat && !lat.match(/^-?\d+\.\d{6}$/)) return false;
            if (lon && !lon.match(/^-?\d+\.\d{6}$/)) return false;

            return true;
        }

        // ==================== –í–ê–õ–ò–î–ê–¶–ò–Ø CSV –§–ê–ô–õ–û–í ====================

        function validateCSVFile(text) {
            const errors = [];
            const warnings = [];

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –§–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π
            if (!text || text.trim().length === 0) {
                errors.push({
                    type: 'critical',
                    message: '–§–∞–π–ª –ø—É—Å—Ç–æ–π',
                    solution: '–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ'
                });
                return { valid: false, errors, warnings };
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
            const detectedDelimiter = detectDelimiter(text);
            if (detectedDelimiter !== ';') {
                errors.push({
                    type: 'delimiter',
                    message: `–ù–µ–≤–µ—Ä–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: –Ω–∞–π–¥–µ–Ω "${detectedDelimiter}"`,
                    solution: '–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π (;) –∫–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤ Excel –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ CSV —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º ";"'
                });
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞
            const lines = text.split('\n').filter(line => line.trim());

            if (lines.length < 2) {
                errors.push({
                    type: 'structure',
                    message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ',
                    solution: '–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö'
                });
                return { valid: false, errors, warnings };
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            const headerColumns = lines[0].split(detectedDelimiter || ';').length;
            const expectedColumns = 22;

            if (headerColumns < expectedColumns) {
                errors.push({
                    type: 'columns',
                    message: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–ª–æ–Ω–æ–∫: –Ω–∞–π–¥–µ–Ω–æ ${headerColumns}, –æ–∂–∏–¥–∞–µ—Ç—Å—è ${expectedColumns}`,
                    solution: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏: –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ò–ù–ù, –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏, –ê–¥—Ä–µ—Å, –®–∏—Ä–æ—Ç–∞, –î–æ–ª–≥–æ—Ç–∞, –¢–µ–ª–µ—Ñ–æ–Ω –∏ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –¥–ª—è –≤—Å–µ—Ö –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏'
                });
            } else if (headerColumns > expectedColumns) {
                warnings.push({
                    message: `–ù–∞–π–¥–µ–Ω–æ –±–æ–ª—å—à–µ –∫–æ–ª–æ–Ω–æ–∫ (${headerColumns}), —á–µ–º –æ–∂–∏–¥–∞–µ—Ç—Å—è (${expectedColumns})`,
                    solution: '–õ–∏—à–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –±—É–¥—É—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã'
                });
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ (–∫–æ—Å–≤–µ–Ω–Ω–∞—è)
            if (hasEncodingIssues(text)) {
                errors.push({
                    type: 'encoding',
                    message: '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π',
                    solution: '–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ Windows-1251. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –≤ Excel —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π'
                });
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 6: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö
            const dataValidation = validateDataRows(lines.slice(1), detectedDelimiter || ';');
            errors.push(...dataValidation.errors);
            warnings.push(...dataValidation.warnings);

            return {
                valid: errors.length === 0,
                errors,
                warnings,
                delimiter: detectedDelimiter
            };
        }

        function detectDelimiter(text) {
            const firstLine = text.split('\n')[0];
            const delimiters = [';', ',', '\t', '|'];
            const counts = {};

            delimiters.forEach(delimiter => {
                counts[delimiter] = (firstLine.match(new RegExp('\\' + delimiter, 'g')) || []).length;
            });

            // –ù–∞—Ö–æ–¥–∏–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
            let maxCount = 0;
            let detectedDelimiter = ';';

            for (let delimiter in counts) {
                if (counts[delimiter] > maxCount) {
                    maxCount = counts[delimiter];
                    detectedDelimiter = delimiter;
                }
            }

            return detectedDelimiter;
        }

        function hasEncodingIssues(text) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤-–º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
            const encodingMarkers = ['ÔøΩ', '√ê', '√ë', '√í'];
            return encodingMarkers.some(marker => text.includes(marker));
        }

        function validateDataRows(dataLines, delimiter) {
            const errors = [];
            const warnings = [];
            const emptyRows = [];
            const invalidRows = [];

            dataLines.forEach((line, index) => {
                const rowNum = index + 2; // +2 –ø–æ—Ç–æ–º—É —á—Ç–æ: +1 –¥–ª—è —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞, +1 –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                const columns = line.split(delimiter);

                if (columns.length < 8) {
                    invalidRows.push({
                        row: rowNum,
                        reason: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö: –Ω–∞–π–¥–µ–Ω–æ ${columns.length} –∫–æ–ª–æ–Ω–æ–∫`
                    });
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                const requiredFields = {
                    1: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ',
                    2: '–ò–ù–ù',
                    3: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏',
                    4: '–ê–¥—Ä–µ—Å',
                    5: '–®–∏—Ä–æ—Ç–∞',
                    6: '–î–æ–ª–≥–æ—Ç–∞',
                    7: '–¢–µ–ª–µ—Ñ–æ–Ω'
                };

                let hasData = false;
                const missingFields = [];

                for (let fieldIndex in requiredFields) {
                    const value = columns[fieldIndex] ? columns[fieldIndex].trim() : '';
                    if (value) {
                        hasData = true;
                    } else {
                        missingFields.push(requiredFields[fieldIndex]);
                    }
                }

                if (hasData && missingFields.length > 0) {
                    invalidRows.push({
                        row: rowNum,
                        reason: `–ü—Ä–æ–ø—É—â–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: ${missingFields.join(', ')}`
                    });
                }

                if (!hasData) {
                    emptyRows.push(rowNum);
                }

                // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                const lat = columns[5] ? columns[5].trim() : '';
                const lon = columns[6] ? columns[6].trim() : '';

                if (lat && !lat.match(/^-?\d+\.?\d*$/)) {
                    invalidRows.push({
                        row: rowNum,
                        reason: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —à–∏—Ä–æ—Ç—ã (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ)'
                    });
                }

                if (lon && !lon.match(/^-?\d+\.?\d*$/)) {
                    invalidRows.push({
                        row: rowNum,
                        reason: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–æ–ª–≥–æ—Ç—ã (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ)'
                    });
                }
            });

            if (emptyRows.length > 0) {
                warnings.push({
                    message: `–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏: ${emptyRows.join(', ')}`,
                    solution: '–ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ'
                });
            }

            if (invalidRows.length > 0) {
                invalidRows.forEach(invalid => {
                    errors.push({
                        type: 'data',
                        message: `–°—Ç—Ä–æ–∫–∞ ${invalid.row}: ${invalid.reason}`,
                        solution: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ'
                    });
                });
            }

            return { errors, warnings };
        }

        function showValidationErrors(validationResult) {
            const modal = document.getElementById('errorModal');
            const content = document.getElementById('errorContent');

            let html = '';

            if (validationResult.errors.length > 0) {
                html += '<h3 style="color: #eb3349; margin-bottom: 15px;">‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:</h3>';
                html += '<ul class="error-list">';
                validationResult.errors.forEach(error => {
                    html += `
                        <li class="error-item">
                            <strong>${error.message}</strong><br>
                            <small>üí° –†–µ—à–µ–Ω–∏–µ: ${error.solution}</small>
                        </li>
                    `;
                });
                html += '</ul>';
            }

            if (validationResult.warnings.length > 0) {
                html += '<h3 style="color: #f2994a; margin: 20px 0 15px 0;">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</h3>';
                html += '<ul class="error-list">';
                validationResult.warnings.forEach(warning => {
                    html += `
                        <li class="warning-item">
                            <strong>${warning.message}</strong><br>
                            <small>üí° ${warning.solution}</small>
                        </li>
                    `;
                });
                html += '</ul>';
            }

            content.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('errorModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê CSV ====================

        function loadCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .csv', 'error');
                event.target.value = '';
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∞–∫—Å 10 –ú–ë)
            const maxSize = 10 * 1024 * 1024; // 10 MB
            if (file.size > maxSize) {
                showNotification('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)', 'error');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    const bytes = new Uint8Array(arrayBuffer);
                    const text = convertFromWindows1251(bytes);

                    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞
                    const validationResult = validateCSVFile(text);

                    if (!validationResult.valid) {
                        showValidationErrors(validationResult);
                        showNotification('–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏. –°–º–æ—Ç—Ä–∏—Ç–µ –¥–µ—Ç–∞–ª–∏.', 'error');
                        event.target.value = '';
                        return;
                    }

                    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
                    if (validationResult.warnings.length > 0) {
                        showValidationErrors(validationResult);
                    }

                    // –ü–∞—Ä—Å–∏–º —Ñ–∞–π–ª
                    parseCSV(text, validationResult.delimiter);
                    showNotification('CSV —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ CSV:', error);
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
                }

                event.target.value = '';
            };

            reader.onerror = function() {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞', 'error');
                event.target.value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê EXCEL ====================

        function loadExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
            const validExtensions = ['.xlsx', '.xls'];
            const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

            if (!validExtensions.includes(fileExtension)) {
                showNotification('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .xlsx –∏–ª–∏ .xls', 'error');
                event.target.value = '';
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∞–∫—Å 20 –ú–ë –¥–ª—è Excel)
            const maxSize = 20 * 1024 * 1024; // 20 MB
            if (file.size > maxSize) {
                showNotification('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 20 –ú–ë)', 'error');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});

                    if (workbook.SheetNames.length === 0) {
                        showNotification('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª Excel –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏—Å—Ç–æ–≤', 'error');
                        event.target.value = '';
                        return;
                    }

                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ''});

                    if (jsonData.length === 0) {
                        showNotification('–§–∞–π–ª Excel –ø—É—Å—Ç', 'error');
                        event.target.value = '';
                        return;
                    }

                    if (jsonData.length === 1) {
                        showNotification('–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö', 'error');
                        event.target.value = '';
                        return;
                    }

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–ª–æ–Ω–æ–∫
                    const headerColumns = jsonData[0].length;
                    if (headerColumns < 22) {
                        showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–ª–æ–Ω–æ–∫ –≤ —Ñ–∞–π–ª–µ: –Ω–∞–π–¥–µ–Ω–æ ${headerColumns}, –æ–∂–∏–¥–∞–µ—Ç—Å—è 22`, 'error');
                        event.target.value = '';
                        return;
                    }

                    parseExcelData(jsonData);
                    showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${jsonData.length - 1} —Å—Ç—Ä–æ–∫ –∏–∑ Excel`, 'success');

                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Excel:', error);
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Excel —Ñ–∞–π–ª–∞: ' + error.message, 'error');
                }

                event.target.value = '';
            };

            reader.onerror = function() {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞', 'error');
                event.target.value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        function parseExcelData(jsonData) {
            document.getElementById('tableBody').innerHTML = '';
            rowCounter = 1;

            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];

                if (row.length >= 8) {
                    const data = {
                        num: row[0] || rowCounter,
                        name: row[1] || '',
                        inn: row[2] || '',
                        pointName: row[3] || '',
                        address: row[4] || '',
                        lat: row[5] || '',
                        lon: row[6] || '',
                        phone: row[7] || '',
                        mon_start: row[8] || '',
                        mon_end: row[9] || '',
                        tue_start: row[10] || '',
                        tue_end: row[11] || '',
                        wed_start: row[12] || '',
                        wed_end: row[13] || '',
                        thu_start: row[14] || '',
                        thu_end: row[15] || '',
                        fri_start: row[16] || '',
                        fri_end: row[17] || '',
                        sat_start: row[18] || '',
                        sat_end: row[19] || '',
                        sun_start: row[20] || '',
                        sun_end: row[21] || ''
                    };

                    addRow(data);
                    rowCounter++;
                }
            }
        }

        function convertFromWindows1251(bytes) {
            const win1251Reverse = {
                0xC0: '–ê', 0xC1: '–ë', 0xC2: '–í', 0xC3: '–ì', 0xC4: '–î', 0xC5: '–ï', 0xA8: '–Å',
                0xC6: '–ñ', 0xC7: '–ó', 0xC8: '–ò', 0xC9: '–ô', 0xCA: '–ö', 0xCB: '–õ', 0xCC: '–ú',
                0xCD: '–ù', 0xCE: '–û', 0xCF: '–ü', 0xD0: '–†', 0xD1: '–°', 0xD2: '–¢', 0xD3: '–£',
                0xD4: '–§', 0xD5: '–•', 0xD6: '–¶', 0xD7: '–ß', 0xD8: '–®', 0xD9: '–©', 0xDA: '–™',
                0xDB: '–´', 0xDC: '–¨', 0xDD: '–≠', 0xDE: '–Æ', 0xDF: '–Ø',
                0xE0: '–∞', 0xE1: '–±', 0xE2: '–≤', 0xE3: '–≥', 0xE4: '–¥', 0xE5: '–µ', 0xB8: '—ë',
                0xE6: '–∂', 0xE7: '–∑', 0xE8: '–∏', 0xE9: '–π', 0xEA: '–∫', 0xEB: '–ª', 0xEC: '–º',
                0xED: '–Ω', 0xEE: '–æ', 0xEF: '–ø', 0xF0: '—Ä', 0xF1: '—Å', 0xF2: '—Ç', 0xF3: '—É',
                0xF4: '—Ñ', 0xF5: '—Ö', 0xF6: '—Ü', 0xF7: '—á', 0xF8: '—à', 0xF9: '—â', 0xFA: '—ä',
                0xFB: '—ã', 0xFC: '—å', 0xFD: '—ç', 0xFE: '—é', 0xFF: '—è', 0xB9: '‚Ññ',
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏ –∏ –∫–∞–≤—ã—á–µ–∫
                0xAB: '¬´', 0xBB: '¬ª',
                0x96: '‚Äì', 0x97: '‚Äî',
                0x85: '‚Ä¶',
                0x91: '‚Äò', 0x92: '‚Äô', 0x93: '‚Äú', 0x94: '‚Äù',
                0x95: '‚Ä¢',
                0x8B: '‚Äπ', 0x9B: '‚Ä∫',
                0xA0: '\u00A0'
            };

            let text = '';
            for (let i = 0; i < bytes.length; i++) {
                const byte = bytes[i];
                if (win1251Reverse[byte]) {
                    text += win1251Reverse[byte];
                } else if (byte < 128) {
                    text += String.fromCharCode(byte);
                } else {
                    text += '?';
                }
            }

            return text;
        }

        function parseCSV(text, delimiter = ';') {
            const lines = text.split('\n').filter(line => line.trim());

            document.getElementById('tableBody').innerHTML = '';
            rowCounter = 1;

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(delimiter);

                if (values.length >= 8) {
                    const data = {
                        num: values[0] || rowCounter,
                        name: values[1] || '',
                        inn: values[2] || '',
                        pointName: values[3] || '',
                        address: values[4] || '',
                        lat: values[5] || '',
                        lon: values[6] || '',
                        phone: values[7] || '',
                        mon_start: values[8] || '',
                        mon_end: values[9] || '',
                        tue_start: values[10] || '',
                        tue_end: values[11] || '',
                        wed_start: values[12] || '',
                        wed_end: values[13] || '',
                        thu_start: values[14] || '',
                        thu_end: values[15] || '',
                        fri_start: values[16] || '',
                        fri_end: values[17] || '',
                        sat_start: values[18] || '',
                        sat_end: values[19] || '',
                        sun_start: values[20] || '',
                        sun_end: values[21] || ''
                    };

                    addRow(data);
                    rowCounter++;
                }
            }
        }

        // ==================== –°–ö–ê–ß–ò–í–ê–ù–ò–ï CSV/EXCEL ====================

        function downloadCSV() {
            const table = document.getElementById('dataTable');
            const rows = table.querySelectorAll('tbody tr');

            if (rows.length === 0) {
                showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }

            let csvContent = '';
            csvContent += CSV_HEADERS.join(';') + '\n';

            let validRowCount = 0;
            let invalidRows = [];

            rows.forEach((row, index) => {
                const rowData = getRowData(row);

                if (!isRowEmpty(rowData)) {
                    if (!isRowValid(rowData)) {
                        invalidRows.push(index + 1);
                        return;
                    }
                    csvContent += rowData.join(';') + '\n';
                    validRowCount++;
                }
            });

            if (invalidRows.length > 0) {
                showNotification(`–û—à–∏–±–∫–∞: —Å—Ç—Ä–æ–∫–∏ ${invalidRows.join(', ')} –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ`, 'error');
                return;
            }

            if (validRowCount === 0) {
                showNotification('–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }

            const blob = new Blob([convertToWindows1251(csvContent)], {
                type: 'text/csv;charset=windows-1251'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification(`CSV —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω (${validRowCount} —Å—Ç—Ä–æ–∫)`, 'success');
        }

        function downloadTemplateCSV() {
            let csvContent = '';
            csvContent += CSV_HEADERS.join(';') + '\n';

            // –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–∏-—à–∞–±–ª–æ–Ω–∞ (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫)
            const sampleRow = [
                '1',
                '–û–û–û "–ö–æ–º–ø–∞–Ω–∏—è"',
                '1234567890',
                '–ú–∞–≥–∞–∑–∏–Ω –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π',
                '–≥. –ì–æ—Ä–æ–¥, —É–ª. –£–ª–∏—Ü–∞, –¥. 1',
                '55.751244',
                '37.618423',
                '+79001234567',
                '09:00', '21:00',
                '09:00', '21:00',
                '09:00', '21:00',
                '09:00', '21:00',
                '09:00', '21:00',
                '10:00', '20:00',
                '10:00', '20:00'
            ];
            csvContent += sampleRow.join(';') + '\n';

            const blob = new Blob([convertToWindows1251(csvContent)], {
                type: 'text/csv;charset=windows-1251'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('–®–∞–±–ª–æ–Ω CSV —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω', 'success');
        }

        function downloadExcel() {
            const table = document.getElementById('dataTable');
            const rows = table.querySelectorAll('tbody tr');

            if (rows.length === 0) {
                showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }

            const data = [];
            data.push(CSV_HEADERS);

            let validRowCount = 0;
            let invalidRows = [];

            rows.forEach((row, index) => {
                const rowData = getRowData(row);

                if (!isRowEmpty(rowData)) {
                    if (!isRowValid(rowData)) {
                        invalidRows.push(index + 1);
                        return;
                    }
                    data.push(rowData);
                    validRowCount++;
                }
            });

            if (invalidRows.length > 0) {
                showNotification(`–û—à–∏–±–∫–∞: —Å—Ç—Ä–æ–∫–∏ ${invalidRows.join(', ')} –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ`, 'error');
                return;
            }

            if (validRowCount === 0) {
                showNotification('–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                return;
            }

            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(workbook, worksheet, '–î–∞–Ω–Ω—ã–µ');

            const fileName = 'data_' + new Date().toISOString().split('T')[0] + '.xlsx';
            XLSX.writeFile(workbook, fileName);

            showNotification(`Excel —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω (${validRowCount} —Å—Ç—Ä–æ–∫)`, 'success');
        }

        function convertToWindows1251(text) {
            const win1251 = {
                '–ê': 0xC0, '–ë': 0xC1, '–í': 0xC2, '–ì': 0xC3, '–î': 0xC4, '–ï': 0xC5, '–Å': 0xA8,
                '–ñ': 0xC6, '–ó': 0xC7, '–ò': 0xC8, '–ô': 0xC9, '–ö': 0xCA, '–õ': 0xCB, '–ú': 0xCC,
                '–ù': 0xCD, '–û': 0xCE, '–ü': 0xCF, '–†': 0xD0, '–°': 0xD1, '–¢': 0xD2, '–£': 0xD3,
                '–§': 0xD4, '–•': 0xD5, '–¶': 0xD6, '–ß': 0xD7, '–®': 0xD8, '–©': 0xD9, '–™': 0xDA,
                '–´': 0xDB, '–¨': 0xDC, '–≠': 0xDD, '–Æ': 0xDE, '–Ø': 0xDF,
                '–∞': 0xE0, '–±': 0xE1, '–≤': 0xE2, '–≥': 0xE3, '–¥': 0xE4, '–µ': 0xE5, '—ë': 0xB8,
                '–∂': 0xE6, '–∑': 0xE7, '–∏': 0xE8, '–π': 0xE9, '–∫': 0xEA, '–ª': 0xEB, '–º': 0xEC,
                '–Ω': 0xED, '–æ': 0xEE, '–ø': 0xEF, '—Ä': 0xF0, '—Å': 0xF1, '—Ç': 0xF2, '—É': 0xF3,
                '—Ñ': 0xF4, '—Ö': 0xF5, '—Ü': 0xF6, '—á': 0xF7, '—à': 0xF8, '—â': 0xF9, '—ä': 0xFA,
                '—ã': 0xFB, '—å': 0xFC, '—ç': 0xFD, '—é': 0xFE, '—è': 0xFF,
                '‚Ññ': 0xB9,
                '¬´': 0xAB, '¬ª': 0xBB,
                '‚Äì': 0x96, '‚Äî': 0x97,
                '‚Ä¶': 0x85,
                '‚Äò': 0x91, '‚Äô': 0x92, '‚Äú': 0x93, '‚Äù': 0x94,
                '‚Ä¢': 0x95,
                '‚Äπ': 0x8B, '‚Ä∫': 0x9B,
                '\u00A0': 0xA0
            };

            const bytes = new Uint8Array(text.length);

            for (let i = 0; i < text.length; i++) {
                const char = text.charAt(i);
                if (win1251[char]) {
                    bytes[i] = win1251[char];
                } else if (char.charCodeAt(0) < 128) {
                    bytes[i] = char.charCodeAt(0);
                } else {
                    bytes[i] = 0x3F; // '?'
                }
            }
            
            return bytes;
        }

        function clearAll() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—Ç—Ä–æ–∫–∏?')) {
                document.getElementById('tableBody').innerHTML = '';
                rowCounter = 1;
                showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã', 'success');
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        window.onload = function() {
            addRow();
        };
    </script>
</body>
</html>
